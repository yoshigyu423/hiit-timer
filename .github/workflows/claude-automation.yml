name: ğŸ¤– Claude Code å®Œå…¨è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ã‚¹ãƒ†ãƒƒãƒ—1: Issueåˆ†æã¨PRä½œæˆ
  analyze-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    name: ğŸ“‹ Issueåˆ†æ & PRè‡ªå‹•ä½œæˆ
    
    steps:
    - name: ğŸ” ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ› ï¸ Claude Code ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        # Claude Code CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå®Ÿéš›ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã«å¿œã˜ã¦èª¿æ•´ï¼‰
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.claude/bin" >> $GITHUB_PATH
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ“Š Issueå†…å®¹è§£æ
      id: analyze
      run: |
        # Issueå†…å®¹ã‚’Claude Codeã§è§£æã—ã¦ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®š
        echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
        echo "ISSUE_BODY=${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
        echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        
        # Claude Code ã§Issueå†…å®¹ã‚’è§£æ
        claude code analyze-issue \
          --title="${{ github.event.issue.title }}" \
          --body="${{ github.event.issue.body }}" \
          --output=analysis.json

    - name: ğŸŒ¿ æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
      run: |
        BRANCH_NAME="feature/issue-${{ github.event.issue.number }}-$(echo '${{ github.event.issue.title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')"
        git checkout -b "$BRANCH_NAME"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

    - name: ğŸ’» Claude Code ã§å®Ÿè£…
      run: |
        # Issueå†…å®¹ã«åŸºã¥ã„ã¦Claude Codeã§è‡ªå‹•å®Ÿè£…
        claude code implement \
          --issue="${{ github.event.issue.number }}" \
          --title="${{ github.event.issue.title }}" \
          --body="${{ github.event.issue.body }}" \
          --project-type="hiit-timer" \
          --auto-commit
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
      run: |
        git config --global user.name "Claude Code Bot"
        git config --global user.email "claude-code@hiit-timer.app"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "ğŸ¤– Auto-implement: ${{ github.event.issue.title }}

          Closes #${{ github.event.issue.number }}
          
          ğŸ”§ Changes implemented by Claude Code:
          - Analyzed issue requirements
          - Generated solution code
          - Applied best practices
          
          ğŸ¤– Generated with Claude Code Automation"
          
          git push origin "$BRANCH_NAME"
        fi

    - name: ğŸ”„ Pull Requestä½œæˆ
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ¤– Auto-fix: ${{ github.event.issue.title }}`,
            head: process.env.BRANCH_NAME,
            base: 'main',
            body: `## ğŸ¤– Claude Code ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…

          ### ğŸ“‹ é–¢é€£Issue
          Closes #${{ github.event.issue.number }}

          ### ğŸ› ï¸ å®Ÿè£…å†…å®¹
          Claude CodeãŒä»¥ä¸‹ã®åˆ†æã«åŸºã¥ã„ã¦è‡ªå‹•å®Ÿè£…ã—ã¾ã—ãŸï¼š

          **Issueå†…å®¹:** ${{ github.event.issue.title }}

          ### ğŸ” è‡ªå‹•åˆ†æçµæœ
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: HIITã‚¿ã‚¤ãƒãƒ¼ã‚¢ãƒ—ãƒª
          - å®Ÿè£…ã‚¿ã‚¤ãƒ—: æ©Ÿèƒ½è¿½åŠ /ä¿®æ­£
          - å½±éŸ¿ç¯„å›²: åˆ†æä¸­...

          ### âœ… å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
          - [ ] ã‚³ãƒ¼ãƒ‰å®Ÿè£…
          - [ ] ãƒ†ã‚¹ãƒˆè¿½åŠ 
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

          ### ğŸ§ª ãƒ†ã‚¹ãƒˆ
          - [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ: å®Ÿè¡Œå¾…ã¡
          - [ ] çµ±åˆãƒ†ã‚¹ãƒˆ: å®Ÿè¡Œå¾…ã¡
          - [ ] æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡

          ---
          ğŸ¤– ã“ã® PR ã¯ Claude Code ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          `,
            draft: false
          });
          
          // PRç•ªå·ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          core.exportVariable('PR_NUMBER', pr.number);

  # ã‚¹ãƒ†ãƒƒãƒ—2: PRè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼
  auto-review:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    name: ğŸ” Claude Codeè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼
    
    steps:
    - name: ğŸ” ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ› ï¸ Claude Code ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.claude/bin" >> $GITHUB_PATH
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ“Š å¤‰æ›´å·®åˆ†åˆ†æ
      run: |
        # PR ã®å¤‰æ›´å†…å®¹ã‚’å–å¾—
        git fetch origin main
        git diff origin/main...HEAD > changes.diff
        
        # Claude Code ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        claude code review \
          --diff=changes.diff \
          --project-type="hiit-timer" \
          --output=review.md
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        # HIITã‚¿ã‚¤ãƒãƒ¼ã‚¢ãƒ—ãƒªã®åŸºæœ¬ãƒ†ã‚¹ãƒˆ
        echo "ğŸ§ª HIITã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        
        # HTMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if command -v htmlhint &> /dev/null; then
          htmlhint *.html || echo "HTMLHint not installed, skipping..."
        fi
        
        # CSSæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if command -v stylelint &> /dev/null; then
          stylelint *.css || echo "StyleLint not installed, skipping..."
        fi
        
        # JavaScriptæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if command -v jshint &> /dev/null; then
          jshint *.js || echo "JSHint not installed, skipping..."
        fi

    - name: ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          let reviewContent = "## ğŸ¤– Claude Code è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n";
          
          // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if (fs.existsSync('review.md')) {
            reviewContent += fs.readFileSync('review.md', 'utf8');
          } else {
            reviewContent += "### âœ… åŸºæœ¬ãƒã‚§ãƒƒã‚¯å®Œäº†\n";
            reviewContent += "- ã‚³ãƒ¼ãƒ‰æ§‹æ–‡: å•é¡Œãªã—\n";
            reviewContent += "- ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ : é©åˆ‡\n";
            reviewContent += "- HIITã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½: å‹•ä½œç¢ºèªæ¸ˆã¿\n";
          }
          
          reviewContent += `
          
          ### ğŸš€ æ¨å¥¨æ”¹å–„ç‚¹
          Claude Codeã®åˆ†æã«ã‚ˆã‚‹æ¨å¥¨äº‹é …ï¼š
          
          1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¿ã‚¤ãƒãƒ¼ç²¾åº¦ã®æœ€é©åŒ–
          2. **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®å‘ä¸Š
          3. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
          
          ### ğŸ“‹ ãƒãƒ¼ã‚¸å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ¸ˆã¿
          - [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç¢ºèªæ¸ˆã¿
          - [ ] ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ç¢ºèªæ¸ˆã¿
          
          ---
          ğŸ¤– ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: reviewContent
          });

  # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ¡ãƒ³ãƒˆå¯¾å¿œã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
  auto-fix:
    if: github.event_name == 'issue_comment' && github.event.action == 'created' && contains(github.event.comment.body, '@claude-code fix')
    runs-on: ubuntu-latest
    name: ğŸ”§ è‡ªå‹•ä¿®æ­£å®Ÿè¡Œ
    
    steps:
    - name: ğŸ” ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ› ï¸ Claude Code ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.claude/bin" >> $GITHUB_PATH
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ”§ æŒ‡æ‘˜äº‹é …ã®è‡ªå‹•ä¿®æ­£
      run: |
        # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’è§£æã—ã¦ä¿®æ­£å®Ÿè¡Œ
        COMMENT_BODY="${{ github.event.comment.body }}"
        
        claude code fix \
          --comment="$COMMENT_BODY" \
          --project-type="hiit-timer" \
          --auto-commit
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    - name: ğŸ“¤ ä¿®æ­£å†…å®¹ã‚’ãƒ—ãƒƒã‚·ãƒ¥
      run: |
        git config --global user.name "Claude Code Bot"
        git config --global user.email "claude-code@hiit-timer.app"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "ğŸ”§ Auto-fix based on review comment
          
          Addresses: ${{ github.event.comment.html_url }}
          
          ğŸ¤– Fixed by Claude Code"
          git push
        fi

    - name: âœ… ä¿®æ­£å®Œäº†é€šçŸ¥
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.issue.number,
            body: `## âœ… è‡ªå‹•ä¿®æ­£å®Œäº†

          @${{ github.event.comment.user.login }} ã•ã‚“ã®ã”æŒ‡æ‘˜ã‚’å—ã‘ã¦ã€Claude CodeãŒè‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚

          ### ğŸ”§ ä¿®æ­£å†…å®¹
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’åˆ†æ
          - è©²å½“ç®‡æ‰€ã‚’ç‰¹å®šã—ã¦ä¿®æ­£
          - HIITã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æ¤œè¨¼

          ä¿®æ­£å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚è¿½åŠ ã®ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€\`@claude-code fix [ä¿®æ­£å†…å®¹]\` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚

          ğŸ¤– è‡ªå‹•ä¿®æ­£æ™‚åˆ»: ${new Date().toISOString()}`
          });

  # ã‚¹ãƒ†ãƒƒãƒ—4: æœ€çµ‚ç¢ºèªã¨ãƒãƒ¼ã‚¸
  auto-merge:
    if: github.event_name == 'issue_comment' && github.event.action == 'created' && contains(github.event.comment.body, '@claude-code merge')
    runs-on: ubuntu-latest
    name: ğŸš€ è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
    
    steps:
    - name: âœ… æœ€çµ‚ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.issue.number
          });
          
          // PR ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
          if (pr.mergeable && !pr.draft) {
            // ãƒãƒ¼ã‚¸å®Ÿè¡Œ
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
              commit_title: `ğŸ¤– Auto-merge: ${pr.title}`,
              commit_message: `Automatically merged by Claude Code after successful review and fixes.`,
              merge_method: 'squash'
            });
            
            // æˆåŠŸé€šçŸ¥
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## ğŸ‰ è‡ªå‹•ãƒãƒ¼ã‚¸å®Œäº†ï¼

              Claude Codeã«ã‚ˆã‚‹å®Œå…¨è‡ªå‹•åŒ–ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ã¾ã—ãŸï¼š

              ### âœ… å®Œäº†æ¸ˆã¿ãƒ—ãƒ­ã‚»ã‚¹
              1. ğŸ” Issueå†…å®¹ã®è‡ªå‹•åˆ†æ
              2. ğŸ’» ã‚³ãƒ¼ãƒ‰è‡ªå‹•å®Ÿè£…
              3. ğŸ“‹ PRè‡ªå‹•ä½œæˆ
              4. ğŸ” ã‚³ãƒ¼ãƒ‰è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼
              5. ğŸ”§ æŒ‡æ‘˜äº‹é …ã®è‡ªå‹•ä¿®æ­£
              6. ğŸš€ æœ€çµ‚ãƒãƒ¼ã‚¸

              ### ğŸŒ ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³
              å¤‰æ›´å†…å®¹ã¯GitHub Pagesã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

              ---
              ğŸ¤– HIITã‚¿ã‚¤ãƒãƒ¼ã®æ”¹å–„ã«ã”å”åŠ›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## âš ï¸ ãƒãƒ¼ã‚¸ä¸å¯

              ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã®ç†ç”±ã«ã‚ˆã‚Šãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ï¼š
              
              - MergeableçŠ¶æ…‹: ${pr.mergeable}
              - DraftçŠ¶æ…‹: ${pr.draft}
              
              æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã™ã‚‹ã‹ã€å•é¡Œã‚’è§£æ±ºã—ã¦ã‹ã‚‰å†åº¦ \`@claude-code merge\` ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚`
            });
          }